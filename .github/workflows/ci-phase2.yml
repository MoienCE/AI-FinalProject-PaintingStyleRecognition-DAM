name: CI - phase-2

on:
  push:
    branches: [ phase-2 ]
  pull_request:
    branches: [ phase-2 ]
  workflow_dispatch: {}

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      WANDB_MODE: offline

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install deps (if exists) & dev-tools
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else echo "no requirements.txt"; fi
          pip install black flake8 pytest || true

      - name: Style check (black)
        run: |
          if command -v black >/dev/null 2>&1; then black --check . || (echo "Run 'black .' locally to fix style" && exit 1); else echo "black not installed"; fi

      - name: Lint (flake8)
        run: |
          if command -v flake8 >/dev/null 2>&1; then flake8 || true; else echo "flake8 not installed"; fi

      - name: Import / smoke checks
        run: |
          python - <<'PY'
          import importlib, sys
          modules = [
            "src.training.train",
            "src.preprocessing.dataset",
            "src.evaluation.evaluate",
            "src.utils.utils",
            "src.data_curation"
          ]
          ok = True
          for m in modules:
              try:
                  importlib.import_module(m)
                  print(f"[OK] imported {m}")
              except Exception as e:
                  print(f"[ERROR] failed to import {m}: {e}")
                  ok = False
          if not ok:
              raise SystemExit("Import checks failed")
          PY

      - name: Run pytest (smoke)
        run: |
          if [ -d tests ] || ls | grep -E 'test_' -q; then pytest -q -k "smoke or not slow" || true; else echo "No tests detected"; fi

      - name: Quick smoke evaluation script
        run: |
          python src/ci/quick_smoke.py || echo "quick_smoke failed but CI continues"

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: report
          path: report.html
